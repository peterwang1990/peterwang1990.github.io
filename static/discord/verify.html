<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect to wallet for Club721</title>
</head>

<body>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script type="application/javascript">
        async function main() {
            let urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has("nonce")) {
                window.close();
                return;
            }

            const nonce = urlParams.get("nonce")
            const timestamp = Math.round(+new Date() / 1000)
            const message = `Tap Fantasy Discord Verification\nNonce: ${nonce}\nTimestamp: ${timestamp}`;

            let accounts = [];
            
            try {
                accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            }
            catch {
            }
            
            if (!accounts.length) {
                alert("Please connect to MetaMask!");
                window.close()
                return;
            }

            const signature = await ethereum.request({ method: 'personal_sign', params: [accounts[0], message] });

            const response = await fetch("/web/user/discord/verify/", {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow', 
                referrerPolicy: 'no-referrer',
                body: JSON.stringify({
                    signature,
                    timestamp,
                    nonce,
                    wallet: accounts[0],
                }),
            });

            if (response.status !== 200) {
                alert("Fail to connect to your wallet! Status Code: " + response.status)
                window.close();
                return;
            }

            var json = await response.json();
            if (json.code !== 0) {
                alert("Sorry, " + json.message);
                window.close();
                return;
            }

            alert("Verification successful.")
            window.close()
        }

        if (window.ethereum === null) {
            alert("Please have MetaMask installed to finish the discord membership verification!");
            window.close()
        } else {
            main().catch(() => {

            })
        }
    </script>
</body>

</html>